- name: Provision Bacalhau Requester
  remote_user: ubuntu
  hosts: tag_Type_requester
  vars:
    ipfs_path: /opt/local/ipfs
  tasks:
    # Must provide limit flag to ensure running against current environment
    - fail:
        msg: "you must use -l or --limit"
      when: ansible_limit is not defined
      run_once: true

    # Aptitude is preferred by ansible
    - name: Install aptitude
      become: yes
      ansible.builtin.apt:
        name: aptitude
        state: latest
        update_cache: true

    - name: Install IPFS
      ansible.builtin.import_tasks: install_ipfs_tasks.yaml

    - name: Install Bacalhau
      ansible.builtin.shell:
        cmd: curl -sL https://get.bacalhau.org/install.sh | bash

    - name: Bump System Resources
      become: yes
      ansible.builtin.command: sysctl -w net.core.rmem_max=2500000

    - name: Install the Bacalhau systemd unit
      become: yes
      ansible.builtin.template:
        src: files/requester.service
        dest: /etc/systemd/system
      vars:
        owner: labdao
        ipfs_connect: /ip4/127.0.0.1/tcp/5001
      notify:
        - Restart Bacalhau

    - name: Systemd Daemon Reload
      become: yes
      ansible.builtin.systemd:
        daemon_reload: true

  handlers:
    - name: Restart Bacalhau
      become: yes
      ansible.builtin.service:
        name: requester
        state: restarted
        enabled: true
