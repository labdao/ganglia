- name: Provision Bacalhau Compute Instance
  remote_user: ubuntu
  hosts: tag_Type_compute_only
  vars:
    nvidia_distribution: ubuntu2004
    ipfs_path: /opt/local/ipfs
    gpu: true
  environment:
    IPFS_PATH: "{{ ipfs_path }}"
  tasks:
    # Aptitude is preferred by ansible
    #
    - name: Install aptitude and other required system packages
      become: yes
      ansible.builtin.apt:
        update_cache: true
        pkg:
          - aptitude
          - curl
          - ca-certificates
          - gnupg
          - lsb-release

    # Docker
    - name: Install Docker
      ansible.builtin.import_tasks: install_docker_tasks.yaml

    # Nvidia
    - name: Add Nvidia Keyring
      become: yes
      ansible.builtin.apt:
        deb: https://developer.download.nvidia.com/compute/cuda/repos/{{ nvidia_distribution }}/x86_64/cuda-keyring_1.1-1_all.deb

    - name: Get Nvidia Container Tookit GPG key
      become: yes
      ansible.builtin.apt_key:
        url: https://nvidia.github.io/libnvidia-container/gpgkey

    - name: Add Nvidia Container Tookit Repository
      become: yes
      ansible.builtin.apt_repository:
        repo: deb https://nvidia.github.io/libnvidia-container/stable/ubuntu18.04/$(ARCH) /
        state: present

    - name: Install required system packages for gpu build
      become: yes
      ansible.builtin.apt:
        pkg:
          - cuda-drivers
        state: latest
        update_cache: true

    - name: Install Nvidia Container Tookit
      become: yes
      ansible.builtin.apt:
        pkg:
          - nvidia-docker2
      notify:
        - Restart docker

    - name: Ensure Nvidia persitence daemon is started
      ansible.builtin.systemd:
        name: nvidia-persistenced

    - name: Install Golag
      become: yes
      vars:
        go_version: 1.20.3
      block:
        - name: Download Go binary
          ansible.builtin.get_url:
            url: https://go.dev/dl/go{{ go_version }}.linux-amd64.tar.gz
            dest: /tmp/go-binary.tar.gz
        - name: Unzip Go binary
          ansible.builtin.command:
            cmd: tar -C /usr/local -xzf /tmp/go-binary.tar.gz

    - name: Install IPFS
      ansible.builtin.import_tasks: install_ipfs_tasks.yaml

    - name: Add the IPFS node to the swarm
      ansible.builtin.command:
        cmd: ipfs swarm connect {{ requester_ipfs_peer }}

    - name: Install Bacalhau
      ansible.builtin.shell:
        cmd: curl -sL https://get.bacalhau.org/install.sh | bash

    - name: Bump System Resources
      become: yes
      ansible.builtin.command: sysctl -w net.core.rmem_max=2500000

    - name: Install the Bacalhau systemd unit
      become: yes
      ansible.builtin.template:
        src: files/compute.service
        dest: /etc/systemd/system
      vars:
        owner: labdao
        ipfs_connect: /ip4/127.0.0.1/tcp/5001
      notify:
        - Restart Bacalhau

    - name: Systemd Daemon Reload
      become: yes
      ansible.builtin.systemd:
        daemon_reload: true

  handlers:
    - name: Restart docker
      become: yes
      ansible.builtin.service:
        name: docker
        state: restarted

    - name: Restart Bacalhau
      become: yes
      ansible.builtin.service:
        name: compute
        state: restarted
        enabled: true
